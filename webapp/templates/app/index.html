{% extends 'app/base.html' %}

{% block title %}Home{% endblock %}
{% block extra_css %}
<style>
		.search-link {
			color: inherit;
			text-decoration: none;
			display: block;
			border-radius: 0.25rem;
		}
		.search-link:hover {
			text-decoration: underline;
		}
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4">Search</h2>

<!-- Bootstrap Tabs -->
<ul class="nav nav-tabs" id="searchTabs" role="tablist">
	<li class="nav-item" role="presentation">
		<button class="nav-link active" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab" aria-controls="customers" aria-selected="true">Customers</button>
	</li>
	<li class="nav-item" role="presentation">
		<button class="nav-link" id="invoices-tab" data-bs-toggle="tab" data-bs-target="#invoices" type="button" role="tab" aria-controls="invoices" aria-selected="false">Invoices</button>
	</li>
</ul>

<div class="tab-content" id="searchTabsContent">
	<!-- Customer Search Tab -->
	<div class="tab-pane fade show active" id="customers" role="tabpanel" aria-labelledby="customers-tab">
		<div class="mt-3">
			<div class="input-group mb-3">
				<span class="input-group-text">Search By</span>
				<select class="form-select" id="fieldSelect" style="max-width: 160px;">
					<option value="any" selected>Any</option>
					<option value="name">Name</option>
					<option value="phone">Phone Number</option>
				</select>
				<input type="text" id="search-input" class="form-control" placeholder="Enter search term...">
			</div>
			<div id="search-results" class="mt-3"></div>
		</div>
	</div>

	<!-- Invoice Search Tab -->
	<div class="tab-pane fade" id="invoices" role="tabpanel" aria-labelledby="invoices-tab">
		<div class="mt-3">
			<div class="row mb-3">
				<div class="col-md-4">
					<label for="invoice-search-field" class="form-label">Search By</label>
					<select class="form-select" id="invoice-search-field">
						<option value="any" selected>Any</option>
						<option value="iid">Invoice ID</option>
						<option value="customer">Customer Name</option>
						<option value="phone">Customer Phone</option>
						<option value="referrer">Referrer Name</option>
					</select>
				</div>
				<div class="col-md-8">
					<label for="invoice-search-input" class="form-label">Search Term</label>
					<input type="text" id="invoice-search-input" class="form-control" placeholder="Enter search term...">
				</div>
			</div>
			
			<div class="row mb-3">
				<div class="col-md-3">
					<label for="date-from" class="form-label">Date From</label>
					<input type="date" id="date-from" class="form-control">
				</div>
				<div class="col-md-3">
					<label for="date-to" class="form-label">Date To</label>
					<input type="date" id="date-to" class="form-control">
				</div>
				<div class="col-md-3">
					<label for="amount-min" class="form-label">Min Amount</label>
					<input type="number" id="amount-min" class="form-control" placeholder="0">
				</div>
				<div class="col-md-3">
					<label for="amount-max" class="form-label">Max Amount</label>
					<input type="number" id="amount-max" class="form-control" placeholder="999999">
				</div>
			</div>
			
			<div class="row mb-3">
				<div class="col-md-4">
					<label for="loyalty-status" class="form-label">Loyalty Status</label>
					<select class="form-select" id="loyalty-status">
						<option value="" selected>All</option>
						<option value="active">Active</option>
						<option value="claimed">Claimed</option>
						<option value="expired">Expired</option>
					</select>
				</div>
				<div class="col-md-4">
					<label for="referral-status" class="form-label">Referral Status</label>
					<select class="form-select" id="referral-status">
						<option value="" selected>All</option>
						<option value="noreferral">No Referral</option>
						<option value="active">Active</option>
						<option value="claimed">Claimed</option>
						<option value="expired">Expired</option>
					</select>
				</div>
				<div class="col-md-4">
					<label for="has-referrer" class="form-label">Has Referrer</label>
					<select class="form-select" id="has-referrer">
						<option value="" selected>All</option>
						<option value="yes">Yes</option>
						<option value="no">No</option>
					</select>
				</div>
			</div>
			
			<div id="invoice-search-results" class="mt-3"></div>
		</div>
	</div>
</div>
{% endblock %}

{% block extra_js %}
<script>
	// Customer Search Functionality
	const input = document.getElementById('search-input');
	const resultsDiv = document.getElementById('search-results');
	const fieldSelect = document.getElementById('fieldSelect');
	let selectedField = fieldSelect.value;
	let lastQuery = '';

	function searchAndUpdate(query, selectedField) {
		lastQuery = query;
		fetch(`/search_customers/?q=${encodeURIComponent(query)}&field=${encodeURIComponent(selectedField)}`)
			.then(response => response.json())
			.then(data => {
				if (input.value.trim() !== lastQuery) return;
				if (data.results.length === 0) {
					resultsDiv.innerHTML = '<div class="text-muted">No customers found.</div>';
				} else {
					resultsDiv.innerHTML = '<ul class="list-group">' +
						data.results.map(c =>
							`<li class='list-group-item'>
								<a href="/customer/${c.cid}" class="search-link">
									<strong>${c.name}</strong> (${c.phone_number})
								</a>
							</li>`
						).join('') +
						'</ul>';
				}
			});
	}

	fieldSelect.addEventListener('change', function() {
		selectedField = fieldSelect.value;
		if (input.value.trim().length > 0) {
			searchAndUpdate(input.value.trim(), selectedField);
		}
	});

	input.addEventListener('input', function () {
		const query = input.value.trim();
		searchAndUpdate(query, selectedField);
	});

	// Invoice Search Functionality
	const invoiceSearchInput = document.getElementById('invoice-search-input');
	const invoiceSearchField = document.getElementById('invoice-search-field');
	const invoiceResultsDiv = document.getElementById('invoice-search-results');
	const dateFrom = document.getElementById('date-from');
	const dateTo = document.getElementById('date-to');
	const amountMin = document.getElementById('amount-min');
	const amountMax = document.getElementById('amount-max');
	const loyaltyStatus = document.getElementById('loyalty-status');
	const referralStatus = document.getElementById('referral-status');
	const hasReferrer = document.getElementById('has-referrer');
	
	let lastInvoiceQuery = '';

	function searchInvoices() {
		const params = new URLSearchParams({
			q: invoiceSearchInput.value.trim(),
			field: invoiceSearchField.value,
			date_from: dateFrom.value,
			date_to: dateTo.value,
			amount_min: amountMin.value,
			amount_max: amountMax.value,
			loyalty_status: loyaltyStatus.value,
			referral_status: referralStatus.value,
			has_referrer: hasReferrer.value
		});

		lastInvoiceQuery = invoiceSearchInput.value.trim();
		
		fetch(`/search_invoices/?${params}`)
			.then(response => response.json())
			.then(data => {
				if (invoiceSearchInput.value.trim() !== lastInvoiceQuery) return;
				if (data.results.length === 0) {
					invoiceResultsDiv.innerHTML = '<div class="text-muted">No invoices found.</div>';
				} else {
					invoiceResultsDiv.innerHTML = '<ul class="list-group">' +
						data.results.map(inv =>
							`<li class='list-group-item'>
								<div class="row">
									<div class="col-md-3">
										<strong>Invoice: ${inv.iid}</strong><br>
										<small class="text-muted">Date: ${inv.date}</small>
									</div>
									<div class="col-md-4">
										<strong>${inv.customer_name}</strong><br>
										<small class="text-muted">${inv.customer_phone}</small>
									</div>
									<div class="col-md-2">
										<strong>â‚¹${inv.total_amount}</strong>
									</div>
									<div class="col-md-3">
										${inv.referrer_name ? `<small>Referred by: ${inv.referrer_name}</small><br>` : ''}
										<small class="badge bg-${inv.loyalty_points_status === 'active' ? 'success' : inv.loyalty_points_status === 'claimed' ? 'warning' : 'secondary'}">${inv.loyalty_points_status}</small>
										${inv.referral_points_status !== 'noreferral' ? `<small class="badge bg-${inv.referral_points_status === 'active' ? 'success' : inv.referral_points_status === 'claimed' ? 'warning' : 'secondary'}">${inv.referral_points_status}</small>` : ''}
									</div>
								</div>
							</li>`
						).join('') +
						'</ul>';
				}
			});
	}

	// Add event listeners for invoice search
	invoiceSearchInput.addEventListener('input', searchInvoices);
	invoiceSearchField.addEventListener('change', searchInvoices);
	dateFrom.addEventListener('change', searchInvoices);
	dateTo.addEventListener('change', searchInvoices);
	amountMin.addEventListener('input', searchInvoices);
	amountMax.addEventListener('input', searchInvoices);
	loyaltyStatus.addEventListener('change', searchInvoices);
	referralStatus.addEventListener('change', searchInvoices);
	hasReferrer.addEventListener('change', searchInvoices);

	// Initial load
	window.addEventListener('DOMContentLoaded', function() {
		searchAndUpdate('', selectedField);
		
		// Add tab switch listener to trigger invoice search when invoice tab is activated
		document.getElementById('invoices-tab').addEventListener('shown.bs.tab', function() {
			searchInvoices();
		});
	});
</script>
{% endblock %}
